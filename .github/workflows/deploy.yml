name: Despliegue Hundir la Flota

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del código
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Configurar Docker Buildx
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3. Construir imagen del Backend
      - name: Build Backend
        run: docker build -t backend ./backend

      # 4. Construir imagen del Frontend
      - name: Build Frontend
        run: docker build -t frontend ./frontend

      # 5. Ejecutar contenedor Backend
      - name: Run Backend
        run: docker run -d -p 5000:5000 --name backend_container backend

      # 6. Ejecutar contenedor Frontend
      - name: Run Frontend
        run: docker run -d -p 80:80 --name frontend_container frontend

      # 7. Instalar Ngrok
      - name: Instalar Ngrok
        run: |
          sudo apt update -y
          sudo apt install -y wget unzip
          wget https://downloads.ngrok.com/linux/stable/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip
          unzip ngrok.zip
          chmod +x ngrok

      # 8. Autenticar Ngrok
      - name: Autenticar Ngrok
        run: ./ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }}

      # 9. Iniciar túnel
      - name: Iniciar túnel Ngrok
        run: |
          ./ngrok http 80 --log=stdout > ngrok.log &
          sleep 5
          curl http://localhost:4040/api/tunnels

      # 10. Mantener el Workflow vivo para pruebas
      - name: Mantener contenedores vivos
        run: sleep 600