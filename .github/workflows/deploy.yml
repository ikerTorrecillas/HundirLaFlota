name: Despliegue Hundir la Flota

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1. Descargar el repositorio
      # -------------------------------
      - name: Checkout del código
        uses: actions/checkout@v3

      # -------------------------------
      # 2. Configurar Docker Buildx
      # -------------------------------
      - name: Configurar Docker
        uses: docker/setup-buildx-action@v2

      # -------------------------------
      # 3. Construir e iniciar Backend
      # -------------------------------
      - name: Construir Backend
        run: docker build -t backend ./backend

      - name: Iniciar Backend
        run: docker run -d -p 5000:5000 --name backend_container backend

      # -------------------------------
      # 4. Construir e iniciar Frontend
      # -------------------------------
      - name: Construir Frontend
        run: docker build -t frontend ./frontend

      - name: Iniciar Frontend
        run: |
          docker run -d -p 80:80 --name frontend_container frontend
          echo "Esperando a que el Frontend arranque..."
          sleep 10

      # -------------------------------
      # 5. Instalar Ngrok
      # -------------------------------
      - name: Instalar Ngrok
        run: |
          sudo apt update
          sudo apt install -y unzip
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip

      # -------------------------------
      # 6. Crear túnel Ngrok al Frontend
      # -------------------------------
      - name: Iniciar túnel Ngrok
        run: |
          ./ngrok http 80 --log=stdout > ngrok.log &
          echo "Esperando a que Ngrok se inicialice..."
          sleep 7
          echo "URL pública de Ngrok:"
          curl http://localhost:4040/api/tunnels

      # -------------------------------
      # 7. Mantener contenedores vivos
      # -------------------------------
      - name: Mantener contenedores vivos
        run: |
          echo "Esperando 10 minutos para que pueda ser probado..."
          sleep 600