name: Despliegue HundirLaFlota

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # === 1. DESCARGAR REPO ===
    - name: Checkout
      uses: actions/checkout@v3

    # === 2. DOCKER ===
    - name: Setup Docker
      uses: docker/setup-buildx-action@v2

    # === 3. BUILD BACKEND ===
    - name: Build Backend
      run: docker build -t backend ./Backend

    - name: Run Backend
      run: docker run -d -p 5000:5000 --name backend_container backend

    # === 4. BUILD FRONTEND ===
    - name: Build Frontend
      run: docker build -t frontend ./FrontEnd

    - name: Run Frontend
      run: docker run -d -p 80:80 --name frontend_container frontend

    # === 5. INSTALAR NGROK ===
    - name: Install Ngrok
      run: |
        sudo apt update
        sudo apt install -y unzip
        wget -O ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip
        unzip ngrok.zip
        sudo mv ngrok /usr/local/bin/

    # === 6. AUTENTICAR NGROK ===
    - name: Auth Ngrok
      run: ngrok authtoken ${{ secrets.NGROK_AUTHTOKEN }}

    # === 7. INICIAR TÃšNEL ===
    - name: Start Ngrok
      run: |
        ngrok http 80 --log=stdout > ngrok.log &
        sleep 6
        curl http://localhost:4040/api/tunnels

    # === 8. MANTENER TODO VIVO ===
    - name: Keep Alive
      run: sleep 600