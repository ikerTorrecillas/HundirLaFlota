name: Despliegue Hundir la Flota

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # 1) Descargar código
      - name: Checkout del código
        uses: actions/checkout@v3

      # 2) Configurar Docker
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3) Construir Backend
      - name: Construir Backend
        run: |
          docker build -t backend ./backend

      # 4) Construir Frontend
      - name: Construir Frontend
        run: |
          docker build -t frontend ./frontend

      # 5) Iniciar contenedor Backend
      - name: Iniciar Backend
        run: |
          docker run -d -p 5000:5000 --name backend_container backend

      # 6) Iniciar contenedor Frontend
      - name: Iniciar Frontend
        run: |
          docker run -d -p 80:80 --name frontend_container frontend

      # 7) Instalar Ngrok
      - name: Instalar Ngrok
        run: |
          sudo apt update
          sudo apt install -y unzip
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip

      # 8) Autenticar Ngrok
      - name: Autenticar Ngrok
        run: |
          ./ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }}

      # 9) Iniciar túnel Ngrok al puerto 80 (Frontend)
      - name: Iniciar túnel Ngrok
        run: |
          ./ngrok http 80 --log=stdout > ngrok.log &
          echo "Esperando a que Ngrok se inicialice..."
          sleep 10
          echo "URL pública de Ngrok:"
          curl http://localhost:4040/api/tunnels

      # 10) Mantener vivo el entorno 10 minutos
      - name: Mantener contenedores vivos
        run: |
          echo "Esperando 10 minutos para pruebas…"
          sleep 600
